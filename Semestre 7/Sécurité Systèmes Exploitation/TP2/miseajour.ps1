# Variables
$PCList = Get-Content -Path "C:\chemin\vers\fichier\PCList.txt"   # Fichier contenant la liste des noms de PC
$UpdateKB = "KBXXXXXX"                                            # Remplacer KBXXXXXX par le numéro de la mise à jour à vérifier
$OutputFile = "C:\chemin\vers\fichier\PCsWithoutUpdate.txt"       # Fichier de sortie pour les PC sans la mise à jour

# Vider le fichier de sortie s'il existe déjà
Clear-Content -Path $OutputFile -ErrorAction SilentlyContinue

# Parcourir la liste des PC
foreach ($PC in $PCList) {
    # Vérifier la connectivité avec le PC en utilisant son nom
    if (Test-Connection -ComputerName $PC -Count 1 -Quiet) {
        try {
            # Récupérer les mises à jour installées sur le PC via le nom de l'ordinateur
            $InstalledUpdates = Get-HotFix -ComputerName $PC
            
            # Vérifier si la mise à jour spécifique est installée
            $UpdateInstalled = $InstalledUpdates | Where-Object { $_.HotFixID -eq $UpdateKB }
            
            # Si la mise à jour n'est pas installée, ajouter le nom du PC dans le fichier de sortie
            if (-not $UpdateInstalled) {
                Add-Content -Path $OutputFile -Value $PC
                Write-Host "Mise à jour $UpdateKB non trouvée sur $PC. Ajouté au fichier."
            } else {
                Write-Host "Mise à jour $UpdateKB est installée sur $PC."
            }
        } catch {
            Write-Host "Erreur lors de la connexion ou de la vérification de $PC : $_"
        }
    } else {
        Write-Host "$PC est injoignable."
    }
}

Write-Host "Vérification terminée. Les PC sans la mise à jour $UpdateKB sont listés dans $OutputFile."
